
from django.shortcuts import render
from django.http import HttpResponse
from django.template import Context, loader
from django.db.models import Q
from models import Arrest_test
from itertools import chain
import datetime
import os
import re

def search(request):
    return render(request, 'SearchPage.html')

def result(request):

    entry=request.META["QUERY_STRING"]
    entry_list=entry.split("&")
    entry_dict={}
    for item in entry_list:
	item_split=item.split("=")
	entry_dict[item_split[0]]=item_split[1]

    def filterByName(QuerySet, stringFilter):
        return QuerySet.filter(Name__icontains=stringFilter)
    def filterByAgencyName(QuerySet, stringFilter):
        return QuerySet.filter(Agency_Name__icontains=stringFilter)
    def filterByCharge(QuerySet, stringFilter):
        return QuerySet.filter(Charge1__icontains=stringFilter)
    def filterByRace(QuerySet, stringFilter):
        return QuerySet.filter(Race__icontains=stringFilter)
    def filterByAddress(QuerySet, stringFilter):
        return QuerySet.filter(Address__icontains=stringFilter)
    def filterByChargeCode(QuerySet, stringFilter):
        return QuerySet.filter(Charge1_DCI_Code__icontains=stringFilter)
    def filterByArrestingOfficer(QuerySet, stringFilter):
        return QuerySet.filter(Arresting_Officer_Signature__icontains=stringFilter)
    def filterByPlaceofArrest(QuerySet, stringFilter):
        return QuerySet.filter(Place_of_Arrest__icontains=stringFilter)
#    def filterByCity(QuerySet, stringFilter):
 #       return QuerySet.filter(city__icontains=stringFilter)
  #  def filterByState(QuerySet, stringFilter):
   #     return QuerySet.filter(state__icontains=stringFilter)
    def filterBySex(QuerySet, stringFilter):
        return QuerySet.filter(Sex__icontains=stringFilter)

    def filterByAge(QuerySet, intFilter):
        return QuerySet.filter(Age=intFilter)
    #def filterByZip(QuerySet, intFilter):
     #   return QuerySet.filter(zip=intFilter)

    def filterByDateArrested(QuerySet, lowerBound, upperBound):
        return QuerySet.filter(Date_Arrested__range=[lowerBound, upperBound])

    def filterBySearchbar(QuerySet, stringFilter):
        stringFilter = stringFilter.replace("+", " ")
        QuerySet = QuerySet.filter(Q(Name__icontains=stringFilter) | Q(Agency_Name__icontains=stringFilter) | Q(Charge1__icontains=stringFilter) | Q(Race__icontains=stringFilter) | Q(Address__icontains=stringFilter) | Q(Charge1_DCI_Code__icontains=stringFilter) | Q(Arresting_Officer_Signature__icontains=stringFilter) | Q(Place_of_Arrest__icontains=stringFilter) | Q(Sex__icontains=stringFilter))
        return QuerySet

    firstDateString = ''
    secondDateString = ''
    agency1 = ''
    agency2 = ''
    agency3 = ''
    firstDateReached = False
    secondDateReached = False
    QuerySet = Arrest_test.objects.all()

    for i in entry_dict.keys():
        entry_dict[i] = entry_dict[i].replace("+", " ")
        if i == 'searchbar':
            if(entry_dict[i] != ''):
                QuerySet = filterBySearchbar(QuerySet, entry_dict[i])                
        if i == 'name':
            QuerySet = filterByName(QuerySet, entry_dict[i])
        if i == 'agency':
            agency1 = entry_dict[i]
            #QuerySet = filterByAgency(QuerySet, entry_dict[i])
        if i == 'agency2':
            agency2 = entry_dict[i]
        if i == 'agency3':
            agency3 = entry_dict[i]
        if i == 'charge':
            QuerySet = filterByChargeCode(QuerySet, entry_dict[i])
        if i == 'race':
            QuerySet = filterByRace(QuerySet, entry_dict[i])
        if i == 'address':
            QuerySet = filterByAddress(QuerySet, entry_dict[i])
        if i == 'offenseCode':
            QuerySet = filterByOffenseCode(QuerySet, entry_dict[i])
        if i == 'officerinvolved':
            QuerySet = filterByArrestingOfficer(QuerySet, entry_dict[i])
    #    if i == 'city':
     #       QuerySet = filterByCity(QuerySet, entry_dict[i])
      #  if i == 'state':
       #     QuerySet = filterByState(QuerySet, entry_dict[i])
        if i == 'sex':
            QuerySet = filterBySex(QuerySet, entry_dict[i])
     #   if i == 'zip':
      #      QuerySet = filterByZip(QuerySet, entry_dict[i])
        if i == 'age':
            QuerySet = filterByAge(QuerySet, entry_dict[i])
        if i == 'from':
            firstDateString = entry_dict[i]
            firstDateReached = True
        if i == 'to':
            secondDateString = entry_dict[i]
            firstDateString = entry_dict[i]
            secondDateReached = True
        if firstDateReached == True:
            if secondDateReached == True:    
                firstDate = datetime.date(int(firstDateString[:4]), int(firstDateString[5:7]), int(firstDateString[8:10]))
                secondDate = datetime.date(int(secondDateString[:4]), int(secondDateString[5:7]), int(secondDateString[8:10]))
                QuerySet = filterByDateOccurred(QuerySet, firstDate, secondDate)
#    if agency1 != '':
 #       if agency2 != '':
  #          if agency3 != '':
   #             QuerySet = QuerySet.filter(Q(agency__icontains=agency1) | Q(agency__icontains=agency2) | Q(agency__icontains=agency3))
    #        else:
     #           QuerySet = QuerySet.filter(Q(agency__icontains=agency1) | Q(agency__icontains=agency2))
      #  else:
       #     QuerySet = QuerySet.filter(Q(agency__icontains=agency1))

    outputList = []
    for j in QuerySet:
        outputList.append([j, j.OCA])

    context = {'outputList':outputList, 'QuerySet':QuerySet}

    return render(request, 'ResultPage.html', context)

def detail(request):
     
     OCARequest=request.META["QUERY_STRING"]
     def filterByOCA(QuerySet, intFilter):
         return QuerySet.filter(OCA=intFilter)

     QuerySet = Arrest_test.objects.all()
     QuerySet = filterByOCA(QuerySet, OCARequest)
     
     context=QuerySet
     return render(request, 'DetailPage.html', context)

